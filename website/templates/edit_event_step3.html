{% extends 'base.html' %}
{% block content %}
<div class="card">
    <div class="card-header">
        <h4>{{ translate('Edit Event') }}: {{ event.ev_title }}</h4>
    </div>
    <div class="card-body">
        <!-- Progress bar -->
        <div class="mb-4">
            <div class="progress" style="height: 25px;">
                <div class="progress-bar bg-success" role="progressbar" style="width: 100%; font-size: 16px;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">{{ translate('Step') }} 3/3</div>
            </div>
            <div class="d-flex justify-content-between mt-2">
                <span class="text-muted">{{ translate('Basic Information') }}</span>
                <span class="text-muted">{{ translate('Courts & Game Settings') }}</span>
                <span class="text-success font-weight-bold">{{ translate('Player Registration') }}</span>
            </div>
        </div>

        <form action="{{ url_for('views.edit_event_step3', event_id=event.ev_id) }}" method="post" id="editPlayersForm">
            
            <!-- Event Info Box -->
            <div class="alert alert-info mb-4">
                <strong>{{ translate('Event Information') }}:</strong><br>
                {{ translate('Type') }}: {{ event.ev_type }} | 
                {{ translate('Max Players') }}: {{ event.ev_max_players }} | 
                {{ translate('Pairing') }}: {{ event.ev_pairing_type }}
            </div>

            <!-- Pairing Type Description -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>{{ translate('How Pairing Works') }}</h5>
                </div>
                <div class="card-body">
                    {% if event.ev_type == 'NonStop' %}
                        {% if event.ev_pairing_type == 'Random' %}
                            <p class="mb-0">{{ translate('Teams will be formed randomly and stay fixed throughout the event. Players will maintain the same partner for all games.') }}</p>
                        {% elif event.ev_pairing_type == 'Manual' %}
                            <p class="mb-0">{{ translate('You assign fixed teams manually. Each team will play together for the entire event with no partner changes.') }}</p>
                        {% elif event.ev_pairing_type == 'L&R Random' %}
                            <p class="mb-0">{{ translate('Players choose their preferred side (left/right), then teams are formed randomly within each side and stay fixed.') }}</p>
                        {% endif %}
                    {% elif event.ev_type == 'Americano' %}
                        <p class="mb-0">{{ translate('Players will rotate partners each round to play with as many different people as possible. The pairing type determines initial team formation only.') }}</p>
                    {% elif event.ev_type == 'Mexicano' %}
                        <p class="mb-0">{{ translate('Players are ranked by performance and paired accordingly each round. Better players will tend to play together as the tournament progresses.') }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Player Registration Section -->
            <div class="card">
                <div class="card-header">
                    <h5>{{ translate('Player Registration') }}</h5>
                    <p class="mb-0 text-muted">{{ translate('Enter player names. If a name doesn\'t exist in the system, a new player account will be created.') }}</p>
                </div>
                <div class="card-body">
                    {% if event.ev_pairing_type == 'Random' %}
                        <!-- Random Pairing: Single column of players -->
                        <div class="row">
                            {% for i in range(event.ev_max_players) %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <label for="player_{{ i }}" class="form-label">{{ translate('Player') }} {{ i + 1 }}</label>
                                    {% set player_name = player_data.random[i] if i < player_data.random|length else '' %}
                                    <input type="text" 
                                           class="form-control player-input" 
                                           id="player_{{ i }}" 
                                           name="player_{{ i }}" 
                                           value="{{ player_name }}"
                                           placeholder="{{ translate('Enter player name') }}">
                                </div>
                            {% endfor %}
                        </div>

                    {% elif event.ev_pairing_type == 'Manual' %}
                        <!-- Manual Pairing: Team-based registration -->
                        {% set teams_needed = (event.ev_max_players / 2) | int %}
                        <div class="row">
                            {% for team_idx in range(teams_needed) %}
                                {% set team_letter = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'[team_idx] %}
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card">
                                        <div class="card-header bg-primary text-white text-center">
                                            <h6 class="mb-0">{{ translate('Team') }} {{ team_letter }}</h6>
                                        </div>
                                        <div class="card-body">
                                            {% set team_data = player_data.team[team_letter] if team_letter in player_data.team else {'player1': '', 'player2': ''} %}
                                            <div class="form-group">
                                                <label for="team_{{ team_letter }}_player1">{{ translate('Player') }} 1</label>
                                                <input type="text" 
                                                       class="form-control player-input" 
                                                       id="team_{{ team_letter }}_player1" 
                                                       name="team_{{ team_letter }}_player1" 
                                                       value="{{ team_data.player1 }}"
                                                       placeholder="{{ translate('Enter player name') }}">
                                            </div>
                                            <div class="form-group mb-0">
                                                <label for="team_{{ team_letter }}_player2">{{ translate('Player') }} 2</label>
                                                <input type="text" 
                                                       class="form-control player-input" 
                                                       id="team_{{ team_letter }}_player2" 
                                                       name="team_{{ team_letter }}_player2" 
                                                       value="{{ team_data.player2 }}"
                                                       placeholder="{{ translate('Enter player name') }}">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                    {% elif event.ev_pairing_type == 'L&R Random' %}
                        <!-- L&R Random: Left and Right columns -->
                        {% set left_players = (event.ev_max_players / 2) | int %}
                        {% set right_players = (event.ev_max_players / 2) | int %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">{{ translate('Left Side Players') }}</h6>
                                    </div>
                                    <div class="card-body">
                                        {% for i in range(left_players) %}
                                            <div class="form-group">
                                                <label for="left_player_{{ i }}">{{ translate('Left Player') }} {{ i + 1 }}</label>
                                                {% set left_name = player_data.left[i] if i < player_data.left|length else '' %}
                                                <input type="text" 
                                                       class="form-control player-input" 
                                                       id="left_player_{{ i }}" 
                                                       name="left_player_{{ i }}" 
                                                       value="{{ left_name }}"
                                                       placeholder="{{ translate('Enter player name') }}">
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-warning text-white">
                                        <h6 class="mb-0">{{ translate('Right Side Players') }}</h6>
                                    </div>
                                    <div class="card-body">
                                        {% for i in range(right_players) %}
                                            <div class="form-group">
                                                <label for="right_player_{{ i }}">{{ translate('Right Player') }} {{ i + 1 }}</label>
                                                {% set right_name = player_data.right[i] if i < player_data.right|length else '' %}
                                                <input type="text" 
                                                       class="form-control player-input" 
                                                       id="right_player_{{ i }}" 
                                                       name="right_player_{{ i }}" 
                                                       value="{{ right_name }}"
                                                       placeholder="{{ translate('Enter player name') }}">
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Navigation buttons -->
            <div class="d-flex justify-content-between mt-4">
                <a href="{{ url_for('views.edit_event_step2', event_id=event.ev_id) }}" class="btn btn-secondary">
                    <i class="fa fa-arrow-left"></i> {{ translate('Previous') }}: {{ translate('Courts & Settings') }}
                </a>
                <button type="submit" class="btn btn-success">
                    <i class="fa fa-save"></i> {{ translate('Update Event & Players') }}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.getElementById('editPlayersForm').addEventListener('submit', function(e) {
    // Basic validation - ensure at least some players are entered
    const playerInputs = document.querySelectorAll('.player-input');
    let playersEntered = 0;
    
    playerInputs.forEach(input => {
        if (input.value.trim()) {
            playersEntered++;
        }
    });
    
    if (playersEntered === 0) {
        e.preventDefault();
        alert('{{ translate("Please enter at least one player name") }}');
        return false;
    }
    
    // Confirm the update
    if (!confirm('{{ translate("Update event with these players? This will replace all existing registrations.") }}')) {
        e.preventDefault();
        return false;
    }
});
</script>
{% endblock %}