{% extends 'base.html' %}
{% block content %}
<div class="mt-4">
    <div class="card">
        <div class="card-header">
            <h4>{{ translate('Edit Event') }}: {{ event.ev_title }}</h4>
        </div>
        <div class="card-body">
            <form action="{{ url_for('views.edit_event', event_id=event.ev_id) }}" method="post" id="editEventForm">
                <div class="form-group">
                    <label for="title">{{ translate('Event Title') }} <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="title" name="title" value="{{ event.ev_title }}" required>
                </div>

                <div class="form-group">
                    <label for="location">{{ translate('Location') }} <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="location" name="location" value="{{ event.ev_location }}" required>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="event_date">{{ translate('Event Date') }} <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="event_date" name="event_date" 
                                   value="{{ event.ev_date.strftime('%Y-%m-%d') }}" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="event_time">{{ translate('Event Time') }} <span class="text-danger">*</span></label>
                            <input type="time" class="form-control" id="event_time" name="event_time" 
                                   value="{{ event.ev_start_time.strftime('%H:%M') }}" required>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="event_type">{{ translate('Event Type') }} <span class="text-danger">*</span></label>
                            <select class="form-control" id="event_type" name="event_type" required>
                                <option value="NonStop" {% if event.ev_type == 'NonStop' %}selected{% endif %}>{{ translate('Non-Stop') }}</option>
                                <option value="Americano" {% if event.ev_type == 'Americano' %}selected{% endif %}>{{ translate('Americano') }}</option>
                                <option value="Mexicano" {% if event.ev_type == 'Mexicano' %}selected{% endif %}>{{ translate('Mexicano') }}</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="max_players">{{ translate('Maximum Players') }} <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="max_players" name="max_players" 
                                   min="4" max="64" step="4" value="{{ event.ev_max_players }}" required>
                            <small class="form-text text-muted">{{ translate('Must be a multiple of 4') }}</small>
                        </div>
                    </div>
                </div>

                <hr>
                <h5>{{ translate('Registration Period') }}</h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="registration_start">{{ translate('Registration Opens') }}</label>
                            <input type="datetime-local" class="form-control" id="registration_start" name="registration_start"
                                   value="{% if event.ev_registration_start %}{{ event.ev_registration_start.strftime('%Y-%m-%dT%H:%M') }}{% endif %}">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="registration_end">{{ translate('Registration Closes') }}</label>
                            <input type="datetime-local" class="form-control" id="registration_end" name="registration_end"
                                   value="{% if event.ev_registration_end %}{{ event.ev_registration_end.strftime('%Y-%m-%dT%H:%M') }}{% endif %}">
                        </div>
                    </div>
                </div>

                <hr>
                <h5>{{ translate('Event Status') }}</h5>
                
                <div class="form-group">
                    <label for="status">{{ translate('Status') }}</label>
                    <select class="form-control" id="status" name="status">
                        <option value="announced" {% if event.ev_status == 'announced' %}selected{% endif %}>{{ translate('Announced') }}</option>
                        <option value="registration_started" {% if event.ev_status == 'registration_started' %}selected{% endif %}>{{ translate('Registration Open') }}</option>
                        <option value="registration_ended" {% if event.ev_status == 'registration_ended' %}selected{% endif %}>{{ translate('Registration Closed') }}</option>
                        <option value="event_started" {% if event.ev_status == 'event_started' %}selected{% endif %}>{{ translate('In Progress') }}</option>
                        <option value="event_ended" {% if event.ev_status == 'event_ended' %}selected{% endif %}>{{ translate('Completed') }}</option>
                    </select>
                </div>

                <div class="form-group text-center">
                    <button type="submit" class="btn btn-success px-5">
                        <i class="fa fa-save"></i> {{ translate('Update Event') }}
                    </button>
                    <a href="{{ url_for('views.detail_event', event_id=event.ev_id) }}" class="btn btn-secondary ml-3 px-5">
                        <i class="fa fa-arrow-left"></i> {{ translate('Cancel') }}
                    </a>
                </div>
            </form>
            
            <!-- Delete/Hide Section -->
            <hr class="mt-5">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fa fa-exclamation-triangle"></i> {{ translate('Danger Zone') }}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>{{ translate('Delete Event') }}</h6>
                            {% if can_delete_event %}
                            <p class="text-muted small">{{ translate('Permanently delete this event. Only possible if no players are registered and no games have been played.') }}</p>
                            <form action="{{ url_for('views.delete_event', event_id=event.ev_id) }}" method="POST" class="d-inline" 
                                  onsubmit="return confirmDelete()">
                                <button type="submit" class="btn btn-danger btn-sm">
                                    <i class="fa fa-trash"></i> {{ translate('Delete Event') }}
                                </button>
                            </form>
                            {% else %}
                            <p class="text-danger small">{{ delete_message }}</p>
                            <button type="button" class="btn btn-danger btn-sm" disabled title="{{ delete_message }}">
                                <i class="fa fa-trash"></i> {{ translate('Delete Event') }}
                            </button>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            {% if event.ev_status == 'canceled' %}
                                <h6>{{ translate('Unhide Event') }}</h6>
                                <p class="text-muted small">{{ translate('Make this event visible to players again (restores to announced status).') }}</p>
                                <form action="{{ url_for('views.hide_event', event_id=event.ev_id) }}" method="POST" class="d-inline"
                                      onsubmit="return confirmUnhide()">
                                    <button type="submit" class="btn btn-success btn-sm">
                                        <i class="fa fa-eye"></i> {{ translate('Unhide Event') }}
                                    </button>
                                </form>
                            {% else %}
                                <h6>{{ translate('Hide Event') }}</h6>
                                <p class="text-muted small">{{ translate('Hide this event from players (marks as canceled). Can be undone.') }}</p>
                                <form action="{{ url_for('views.hide_event', event_id=event.ev_id) }}" method="POST" class="d-inline"
                                      onsubmit="return confirmHide()">
                                    <button type="submit" class="btn btn-warning btn-sm">
                                        <i class="fa fa-eye-slash"></i> {{ translate('Hide Event') }}
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('editEventForm').addEventListener('submit', function(e) {
    const maxPlayers = parseInt(document.getElementById('max_players').value);
    if (maxPlayers % 4 !== 0) {
        e.preventDefault();
        alert('{{ translate("Maximum players must be a multiple of 4") }}');
        return false;
    }
    
    const regStart = document.getElementById('registration_start').value;
    const regEnd = document.getElementById('registration_end').value;
    
    if (regStart && regEnd && regStart >= regEnd) {
        e.preventDefault();
        alert('{{ translate("Registration end must be after registration start") }}');
        return false;
    }
});

// Delete and Hide confirmation functions
function confirmDelete() {
    return confirm('{{ translate("Are you sure you want to permanently delete this event? This action cannot be undone!") }}');
}

function confirmHide() {
    return confirm('{{ translate("Are you sure you want to hide this event from players?") }}');
}

function confirmUnhide() {
    return confirm('{{ translate("Are you sure you want to make this event visible to players again?") }}');
}
</script>
{% endblock %}