{% extends 'base.html' %}
{% block content %}
<div class="card">
    <div class="card-header">
        <h4>{{ translate('Edit Event') }}: {{ event.ev_title }}</h4>
    </div>
    <div class="card-body">
        <!-- Progress bar -->
        <div class="mb-4">
            <div class="progress" style="height: 25px;">
                <div class="progress-bar bg-primary" role="progressbar" style="width: 67%; font-size: 16px;" aria-valuenow="67" aria-valuemin="0" aria-valuemax="100">{{ translate('Step') }} 2/3</div>
            </div>
            <div class="d-flex justify-content-between mt-2">
                <span class="text-muted">{{ translate('Basic Information') }}</span>
                <span class="text-primary font-weight-bold">{{ translate('Courts & Game Settings') }}</span>
                <span class="text-muted">{{ translate('Player Registration') }}</span>
            </div>
        </div>

        <form action="{{ url_for('views.edit_event_step2', event_id=event.ev_id) }}" method="post" id="editEventForm">
            
            <!-- Event Type and Settings -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>{{ translate('Event Type & Player Settings') }}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="event_type_id">{{ translate('Event Type') }} <span class="text-danger">*</span></label>
                                <select class="form-control" id="event_type_id" name="event_type_id" required>
                                    {% for event_type in event_types %}
                                    <option value="{{ event_type.et_id }}" {% if event.ev_type_id == event_type.et_id %}selected{% endif %}>{{ translate(event_type.et_name) }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="max_players">{{ translate('Maximum Players') }} <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="max_players" name="max_players" 
                                       value="{{ event.ev_max_players }}" min="4" max="32" step="2" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="pairing_type">{{ translate('Pairing Type') }} <span class="text-danger">*</span></label>
                                <select class="form-control" id="pairing_type" name="pairing_type" required>
                                    <option value="Random" {% if event.ev_pairing_type == 'Random' %}selected{% endif %}>{{ translate('Random') }}</option>
                                    <option value="Manual" {% if event.ev_pairing_type == 'Manual' %}selected{% endif %}>{{ translate('Manual') }}</option>
                                    <option value="L&R Random" {% if event.ev_pairing_type == 'L&R Random' %}selected{% endif %}>{{ translate('L&R Random') }}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info" id="pairingDescription">
                        <!-- Pairing descriptions will be updated via JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Court Configuration -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>{{ translate('Court Configuration') }}</h5>
                    <p class="mb-0 text-muted">{{ translate('Configure courts for this event') }}</p>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="court_count">{{ translate('Number of Courts') }} <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="court_count" name="court_count" 
                               value="{{ existing_event_courts|length or 1 }}" min="1" max="10" required>
                    </div>
                    
                    <div id="courtsContainer">
                        {% for i in range(existing_event_courts|length or 1) %}
                        <div class="court-row row mb-3">
                            <div class="col-md-12">
                                <label for="court_{{ i }}">{{ translate('Court') }} {{ i + 1 }}</label>
                                <select class="form-control" id="court_{{ i }}" name="court_{{ i }}" required>
                                    {% for court in courts %}
                                        {% set selected_court = existing_event_courts[i] if i < existing_event_courts|length else none %}
                                        <option value="{{ court.ct_id }}" 
                                                {% if selected_court and selected_court.evc_court_id == court.ct_id %}selected{% endif %}>
                                            {{ court.ct_name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Navigation buttons -->
            <div class="d-flex justify-content-between">
                <a href="{{ url_for('views.edit_event_step1', event_id=event.ev_id) }}" class="btn btn-secondary">
                    <i class="fa fa-arrow-left"></i> {{ translate('Previous') }}: {{ translate('Basic Information') }}
                </a>
                <button type="submit" class="btn btn-success">
                    {{ translate('Next') }}: {{ translate('Player Registration') }} <i class="fa fa-arrow-right"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Update pairing descriptions based on event type
function updatePairingDescription() {
    const eventType = document.getElementById('event_type').value;
    const pairingType = document.getElementById('pairing_type').value;
    const descriptionDiv = document.getElementById('pairingDescription');
    
    let description = '';
    
    if (eventType === 'NonStop') {
        if (pairingType === 'Random') {
            description = '{{ translate("NonStop + Random: Teams are formed randomly and stay fixed throughout the event") }}';
        } else if (pairingType === 'Manual') {
            description = '{{ translate("NonStop + Manual: You manually assign fixed teams for the entire event") }}';
        } else if (pairingType === 'L&R Random') {
            description = '{{ translate("NonStop + L&R Random: Players choose left/right preference, then random teams are formed and stay fixed") }}';
        }
    } else if (eventType === 'Americano') {
        description = '{{ translate("Americano: Players rotate partners to play with everyone. Pairing type determines initial team formation, but teams change each round to maximize player mixing") }}';
    } else if (eventType === 'Mexicano') {
        description = '{{ translate("Mexicano: Players are ranked by performance and paired accordingly each round. Higher-performing players play together") }}';
    }
    
    descriptionDiv.innerHTML = description;
}

// Update court configuration
function updateCourts() {
    const courtCount = parseInt(document.getElementById('court_count').value);
    const container = document.getElementById('courtsContainer');
    container.innerHTML = '';
    
    for (let i = 0; i < courtCount; i++) {
        const courtRow = document.createElement('div');
        courtRow.className = 'court-row row mb-3';
        courtRow.innerHTML = `
            <div class="col-md-12">
                <label for="court_${i}">{{ translate('Court') }} ${i + 1}</label>
                <select class="form-control" id="court_${i}" name="court_${i}" required>
                    {% for court in courts %}
                    <option value="{{ court.ct_id }}">{{ court.ct_name }}</option>
                    {% endfor %}
                </select>
            </div>
        `;
        container.appendChild(courtRow);
    }
}

// Initialize
updatePairingDescription();

// Event listeners
document.getElementById('event_type').addEventListener('change', updatePairingDescription);
document.getElementById('pairing_type').addEventListener('change', updatePairingDescription);
document.getElementById('court_count').addEventListener('change', updateCourts);
</script>
{% endblock %}